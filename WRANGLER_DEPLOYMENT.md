# Wrangler Deployment Setup

This document explains the Wrangler deployment configuration for Deskbot PWA.

## Overview

The project has been configured to deploy to Cloudflare Workers using Workers Assets for serving the PWA static files and providing an API endpoint.

## Structure

```
Deskbot/
├── src/
│   └── index.ts          # Worker entry point
├── web/                  # PWA source files
│   ├── index.html
│   ├── app.js
│   ├── style.css
│   ├── manifest.webmanifest
│   ├── service-worker.js
│   └── icons/
├── dist/                 # Built PWA (generated by build script)
├── scripts/
│   └── build.js          # Copies web/ to dist/
├── wrangler.jsonc        # Wrangler configuration
└── package.json          # npm scripts
```

## Configuration Files

### wrangler.jsonc
```json
{
  "name": "deskbot",
  "compatibility_date": "2025-12-24",
  "main": "src/index.ts",
  "assets": {
    "directory": "./dist"
  }
}
```

### package.json scripts
```json
{
  "scripts": {
    "build": "node scripts/build.js",
    "dev": "wrangler dev",
    "deploy": "npm run build && wrangler versions upload"
  }
}
```

## Worker Logic (src/index.ts)

The Worker handles three types of requests:

1. **CORS Preflight (OPTIONS)**: Returns appropriate CORS headers
2. **API Route (/api/deskbot/turn)**: Handles audio turns for voice interaction
   - Returns 501 if GEMINI_API_KEY is not configured
   - Processes audio and returns responses when API key is set
3. **Static Assets (everything else)**: Serves from Workers Assets (./dist)

## Deployment

### Prerequisites

```bash
npm install
```

### Build the PWA

```bash
npm run build
```

This copies files from `/web` to `/dist`.

### Deploy to Cloudflare Workers

```bash
# Method 1: Using npm script
npm run deploy

# Method 2: Direct wrangler command
npx wrangler versions upload
```

### Set API Key (Optional)

If you want to enable the Gemini AI backend:

```bash
npx wrangler secret put GEMINI_API_KEY
# Enter your Google Gemini API key when prompted
```

### Local Development

```bash
npm run dev
```

This starts wrangler dev server at http://localhost:8787

## Success Criteria

✅ **wrangler versions upload** finds src/index.ts and ./dist
✅ The deployed URL serves the PWA
✅ /manifest.webmanifest is reachable
✅ /service-worker.js is reachable
✅ /api/deskbot/turn returns 501 when API key is not set

## Endpoints

- `GET /` - Serves the PWA index.html
- `GET /manifest.webmanifest` - PWA manifest
- `GET /service-worker.js` - Service worker for offline support
- `GET /app.js` - PWA application logic
- `GET /style.css` - PWA styles
- `GET /icon-*.png` - PWA icons
- `POST /api/deskbot/turn` - Voice interaction API
  - Accepts multipart/form-data with audio file
  - Returns JSON with transcript, replyText, and replyAudioUrl

## Testing

### Test Build
```bash
npm run build
ls -la dist/
```

### Test Deployment (Dry Run)
```bash
npx wrangler versions upload --dry-run
```

### Test Locally
```bash
npm run dev
curl http://localhost:8787/
curl http://localhost:8787/manifest.webmanifest
```

## Troubleshooting

### "Missing entry-point to Worker script"
- Ensure `src/index.ts` exists
- Ensure `wrangler.jsonc` has `"main": "src/index.ts"`

### "Assets directory not found"
- Run `npm run build` first to generate ./dist
- Ensure `wrangler.jsonc` has correct assets directory

### API returns 501
- This is expected if GEMINI_API_KEY is not set
- Set the API key with `wrangler secret put GEMINI_API_KEY`

## Migration Notes

The previous setup had the worker in `/worker/` subdirectory. The new setup:
- Moves worker entry to `/src/index.ts` at root level
- Uses Workers Assets instead of separate static hosting
- Combines PWA serving and API in a single Worker
- Uses `wrangler versions upload` for deployment
